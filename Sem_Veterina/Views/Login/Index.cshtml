@using Sem_Veterina.Controllers
@using Sem_Veterina.Entity
@model Sem_Veterina.Models.CombinedViewModel

@{
    ViewData["Title"] = "Svět zvířat";
    Layout = "_LoginLayout"; // Používáme layout
}

<main class="main">
    <h1 class="main-titul">Vítejte v systému <span class="main-logo">Svět zvířat</span></h1>
    <div class="main-info">
        <img class="img-kliniky" src="~/imgs/vetCare.png" alt="Obrázek kliniky" width="426" height="400" />
        <div class="main-description">
            <p class="description">Tento systém vám umožňuje snadno sledovat zdravotní stav vašich mazlíčků.</p>
            <p class="description">Získejte přístup ke kompletním informacím o pacientech, včetně zákroků, diagnóz a
                laboratorních výsledků – vše na jednom místě, přehledně a jednoduše.
            </p>
        </div>
    </div>
    <div class="buttons-form">
        <button class="button-form btn" data-bs-toggle="modal" data-bs-target="#registerModal">Registrovat
            se</button>
        <button class="button-form btn" data-bs-toggle="modal" data-bs-target="#loginModal">Přihlásit
            se</button>
    </div>

</main>
<!-- Modal pro Registraci -->
<div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-custom">
        <div class="modal-content">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="modal-body">
                <p class="modal-titel">Vytvořte si účet pro přístup</p>
                @if (!ViewData.ModelState.IsValid)
                {
                    foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                    {
                        <div class="text-danger">@error.ErrorMessage</div>
                    }
                }

                <form asp-action="Register" asp-controller="Login" class="form-modal" id="registerForm">
                    <div>
                        <label for="register-username" class="form-label">Uživatelské jméno</label>
                        <input type="text" class="form-control filter-input" name="RegisterUsername"
                            asp-for="Register.RegisterUsername" id="register-username" placeholder="AnnaSvobodova"
                            data-val="true">
                        @* pro zobrazeni chyb *@
                        @Html.ValidationMessageFor(m => m.Register.RegisterUsername, null, new
                            {
                                @class =
                                 "text-danger"
                            })
                    </div>
                    <div>
                        <label for="register-password" class="form-label">Heslo</label>
                        <input type="password" class="form-control filter-input" name="RegisterPassword"
                            asp-for="Register.RegisterPassword" id="register-password" placeholder="Zadejte své heslo"
                            data-val="true">
                        @Html.ValidationMessageFor(m => m.Register.RegisterPassword, null, new
                            {
                                @class =
                                 "text-danger"
                            })
                    </div>
                    <button type="submit" class="button-form btn">Vytvořit účet</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Modal pro Přihlášení -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-custom">
        <div class="modal-content">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="modal-body">
                <p class="modal-titel">Vítejte zpět! Přihlaste se</p>
                <form asp-action="Login" asp-controller="Login" class="form-modal" id="loginForm">
                    <div>
                        <label for="login-username" class="form-label">Uživatelské jméno</label>
                        <input type="text" class="form-control filter-input" name="LoginUsername"
                            asp-for="Login.LoginUsername" id="login-username" placeholder="AnnaSvobodova">
                        @Html.ValidationMessageFor(m => m.Login.LoginUsername, null, new
                            {
                                @class = "text-danger"
                            })
                    </div>
                    <div>
                        <label for="login-password" class="form-label">Heslo</label>
                        <input type="password" class="form-control filter-input" name="LoginPassword"
                            asp-for="Login.LoginPassword" id="login-password" placeholder="Zadejte své heslo">
                        @Html.ValidationMessageFor(m => m.Login.LoginPassword, null, new
                            {
                                @class = "text-danger"
                            })
                    </div>
                    <button type="submit" class="button-form btn">Přihlasit se</button>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

<script>
    // Funkce pro zobrazení modálů
    function displayModal() {
        $(document).ready(function () {
            if (window.LoginModal === true) {
                console.log("Zobrazuji login modal");
                $("#loginModal").modal("show");
            }
            if (window.RegisterModal === true) {
                console.log("Zobrazuji register modal");
                $("#registerModal").modal("show");
            }
        });
    }

    // Nastavení hodnot pro modály
    window.LoginModal = @((ViewBag.LoginModal != null && ViewBag.LoginModal == true).ToString().ToLower());
    window.RegisterModal = @((ViewBag.RegisterModal != null && ViewBag.RegisterModal == true).ToString().ToLower());
    @* 
        // Zavolání funkce pro zobrazení modálů
        @if (ViewBag.LoginModal != null && ViewBag.LoginModal == true)
    {
        <text>window.LoginModal = true;</text>
    }
    else
    {
        <text>window.LoginModal = false;</text>
    }

    @if (ViewBag.RegisterModal != null && ViewBag.RegisterModal == true)
    {
        <text>window.RegisterModal = true;</text>
    }
    else
    {
        <text>window.RegisterModal = false;</text>
    } *@

        displayModal();  // Zavolání funkce po nastavení modálního stavu
</script>

<script>
    // Globální proměnná pro sledování stavu
    let isManualClose = false;

    @* event.target.classList.contains('btn-close') || event.target === this *@
        document.getElementById('registerModal').addEventListener('click', function (event) {
            if (event.target.classList.contains('btn-close')) {
                isManualClose = true;
            }
        });

    document.getElementById('loginModal').addEventListener('click', function (event) {
        if (event.target.classList.contains('btn-close')) {
            isManualClose = true;
        }
    });

    // Event listener pro sledování manuálního zavření modalu
    document.getElementById('loginModal').addEventListener('hide.bs.modal', function (event) {
        if (isManualClose) {
            const form = this.querySelector('form');
            if (form) {
                form.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
                form.classList.remove('was-validated');
                form.reset();
            }
            isManualClose = false; // Reset manuálního stavu
        }
    });

    // Podobné pro registerModal
    document.getElementById('registerModal').addEventListener('hide.bs.modal', function (event) {
        if (isManualClose) {
            const form = this.querySelector('form');
            if (form) {
                form.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
                form.classList.remove('was-validated');
                form.reset();
            }
            isManualClose = false; // Reset manuálního stavu
        }
    });

    document.getElementById('registerModal').addEventListener('show.bs.modal', function () {
        const loginForm = document.querySelector('#loginModal form');
        if (loginForm) {
            loginForm.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
            loginForm.classList.remove('was-validated');
            loginForm.reset();
        }
    });

    document.getElementById('loginModal').addEventListener('show.bs.modal', function () {
        const registerForm = document.querySelector('#registerModal form');
        if (registerForm) {
            registerForm.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
            registerForm.classList.remove('was-validated');
            registerForm.reset();
        }
    });


</script>